<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analytics - ArtView Museum</title>
    <link rel="stylesheet" href="css/style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Include Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: transform 0.2s ease;
      }

      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: #2c5aa0;
        margin-bottom: 0.5rem;
      }

      .stat-label {
        color: #666;
        font-size: 0.9rem;
      }

      .chart-container {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
      }

      .chart-title {
        margin-bottom: 1rem;
        color: #333;
        font-family: "Playfair Display", serif;
      }

      .analytics-section {
        margin-bottom: 2rem;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .refresh-btn {
        background: #2c5aa0;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      .refresh-btn:hover {
        background: #1e3a8a;
      }

      .refresh-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .top-artworks {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .artwork-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid #eee;
        transition: background 0.2s ease;
      }

      .artwork-item:hover {
        background: #f8f9fa;
      }

      .artwork-item:last-child {
        border-bottom: none;
      }

      .artwork-rank {
        font-weight: bold;
        margin-right: 1rem;
        color: #2c5aa0;
        font-size: 1.2rem;
        min-width: 2rem;
      }

      .artwork-info {
        flex: 1;
      }

      .artwork-views {
        color: #666;
        font-weight: 500;
        background: #f8f9fa;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.9rem;
      }

      .loading {
        text-align: center;
        padding: 2rem;
        color: #666;
      }

      .loading i {
        animation: spin 1s linear infinite;
        margin-right: 0.5rem;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .last-updated {
        text-align: right;
        color: #666;
        font-size: 0.875rem;
        margin-top: 1rem;
      }

      .export-btn {
        background: #4caf50;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 0.5rem;
        transition: background 0.3s ease;
      }

      .export-btn:hover {
        background: #45a049;
      }

      @media (max-width: 768px) {
        .section-header {
          flex-direction: column;
          gap: 1rem;
          align-items: flex-start;
        }

        .analytics-grid {
          grid-template-columns: 1fr;
        }

        .artwork-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.5rem;
        }

        .artwork-views {
          align-self: flex-end;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <nav class="navbar">
          <div class="logo">
            <i class="fas fa-museum logo-icon"></i>
            <span>ArtView Analytics</span>
          </div>
          <div class="nav-links">
            <a href="index.html" class="nav-link">Public Site</a>
            <a href="scanner.html" class="nav-link">Scanner</a>
            <a href="admin.html" class="nav-link">Admin Panel</a>
            <a href="analytics.html" class="nav-link active">Analytics</a>
            <a href="#" class="nav-link" id="logoutBtn">
              <i class="fas fa-sign-out-alt"></i>
              Logout
            </a>
          </div>
        </nav>
      </div>
    </header>

    <section class="admin-hero">
      <div class="container">
        <div class="admin-welcome">
          <h1>Museum Analytics Dashboard</h1>
          <p>Welcome, <span id="userWelcome">Staff Member</span></p>
        </div>
      </div>
    </section>

    <main class="main-content">
      <div class="container">
        <div class="analytics-panel">
          <!-- Overview Stats -->
          <div class="analytics-section">
            <div class="section-header">
              <h2>Overview</h2>
              <div>
                <button
                  class="refresh-btn"
                  id="refreshBtn"
                  onclick="loadAnalytics()"
                >
                  <i class="fas fa-sync-alt"></i>
                  Refresh Data
                </button>
                <button class="export-btn" onclick="exportData()">
                  <i class="fas fa-download"></i>
                  Export Data
                </button>
              </div>
            </div>

            <div class="analytics-grid">
              <div class="stat-card">
                <div class="stat-number" id="totalScans">0</div>
                <div class="stat-label">Total QR Scans</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="totalArtworks">0</div>
                <div class="stat-label">Artworks in Collection</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="uniqueVisitors">0</div>
                <div class="stat-label">Unique Visitors</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="avgEngagement">0s</div>
                <div class="stat-label">Avg. Engagement Time</div>
              </div>
            </div>
            <div class="last-updated" id="lastUpdated">
              Last updated: <span id="updateTime">Never</span>
            </div>
          </div>

          <!-- Charts Section -->
          <div class="analytics-section">
            <h2>Scan Analytics</h2>
            <div class="analytics-grid">
              <div class="chart-container">
                <h3 class="chart-title">Scans by Hour</h3>
                <canvas id="hourlyChart"></canvas>
              </div>
              <div class="chart-container">
                <h3 class="chart-title">Scans by Day</h3>
                <canvas id="dailyChart"></canvas>
              </div>
            </div>
          </div>

          <!-- Top Artworks -->
          <div class="analytics-section">
            <h2>Most Popular Artworks</h2>
            <div class="top-artworks" id="topArtworksList">
              <div class="loading">
                <i class="fas fa-spinner"></i> Loading popular artworks...
              </div>
            </div>
          </div>

          <!-- Engagement Metrics -->
          <div class="analytics-section">
            <h2>Visitor Engagement</h2>
            <div class="analytics-grid">
              <div class="chart-container">
                <h3 class="chart-title">Engagement Time Distribution</h3>
                <canvas id="engagementChart"></canvas>
              </div>
              <div class="chart-container">
                <h3 class="chart-title">Scan Sources</h3>
                <canvas id="sourceChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <div class="container">
        <div class="footer-content">
          <div class="footer-section">
            <h3>ArtView Museum</h3>
            <p>Analytics dashboard for museum insights.</p>
          </div>
        </div>
      </div>
    </footer>

    <script>
      // Authentication check
      document.addEventListener("DOMContentLoaded", function () {
        const isLoggedIn = localStorage.getItem("isLoggedIn");

        if (isLoggedIn !== "true") {
          window.location.href = "login.html";
          return;
        }

        // Update welcome message
        const userWelcome = document.getElementById("userWelcome");
        if (userWelcome) {
          const userName = localStorage.getItem("username") || "Staff Member";
          userWelcome.textContent = userName;
        }

        // Setup logout
        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", function (e) {
            e.preventDefault();
            logout();
          });
        }

        // Load analytics data
        loadAnalytics();
      });

      // Logout function
      function logout() {
        // Clear all login-related data
        localStorage.removeItem("isLoggedIn");
        localStorage.removeItem("username");
        localStorage.removeItem("loginTime");
        localStorage.removeItem("userWelcome");
        localStorage.removeItem("userRole");

        // Redirect to login page with logout message
        window.location.href = "login.html?logout=true";
      }

      let hourlyChart, dailyChart, engagementChart, sourceChart;
      let currentAnalyticsData = null;

      async function loadAnalytics() {
        try {
          const refreshBtn = document.getElementById("refreshBtn");
          refreshBtn.disabled = true;
          refreshBtn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Refreshing...';

          // Show loading states
          document.querySelectorAll(".stat-number").forEach((el) => {
            el.textContent = "...";
          });

          // Try to fetch from backend API first, then fallback to demo data
          let analyticsData;
          try {
            analyticsData = await fetchBackendAnalytics();
          } catch (error) {
            console.log("Backend unavailable, using demo data");
            analyticsData = await fetchDemoAnalyticsData();
          }

          currentAnalyticsData = analyticsData;
          updateStats(analyticsData.stats);
          updateCharts(analyticsData.charts);
          updateTopArtworks(analyticsData.topArtworks);

          // Update last updated time
          document.getElementById("updateTime").textContent =
            new Date().toLocaleString();
        } catch (error) {
          console.error("Error loading analytics:", error);
          alert("Error loading analytics data. Please try again.");
        } finally {
          const refreshBtn = document.getElementById("refreshBtn");
          refreshBtn.disabled = false;
          refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
        }
      }

      async function fetchBackendAnalytics() {
        // Try to fetch from your backend API
        const [statsResponse, popularResponse, hourlyResponse, dailyResponse] =
          await Promise.all([
            fetch("/api/analytics/overview").then((r) =>
              r.ok ? r.json() : Promise.reject()
            ),
            fetch("/api/analytics/popular").then((r) =>
              r.ok ? r.json() : Promise.reject()
            ),
            fetch("/api/analytics/hourly").then((r) =>
              r.ok ? r.json() : Promise.reject()
            ),
            fetch("/api/analytics/daily").then((r) =>
              r.ok ? r.json() : Promise.reject()
            ),
          ]);

        return {
          stats: statsResponse.stats,
          topArtworks: popularResponse.artworks,
          charts: {
            hourly: hourlyResponse.data,
            daily: dailyResponse.data.map((d) => d.scans),
            engagement: [25, 40, 20, 10, 5], // Default values
            sources: [65, 25, 10], // Default values
          },
        };
      }

      async function fetchDemoAnalyticsData() {
        // Simulate API call delay
        await new Promise((resolve) => setTimeout(resolve, 1000));

        // Get actual artworks from localStorage for accurate count
        const artworks = JSON.parse(localStorage.getItem("artworks")) || [];
        const scanAnalytics =
          JSON.parse(localStorage.getItem("scanAnalytics")) || [];

        // Calculate real stats from localStorage data
        const totalScans = scanAnalytics.length;
        const uniqueVisitors = new Set(
          scanAnalytics.map((scan) => scan.userAgent)
        ).size;

        // Demo data - replace with actual API calls
        return {
          stats: {
            totalScans: totalScans || 1247,
            totalArtworks: artworks.length || 45,
            uniqueVisitors: uniqueVisitors || 892,
            avgEngagement: "2:45",
          },
          charts: {
            hourly: [
              12, 8, 15, 22, 18, 25, 30, 45, 38, 32, 28, 20, 15, 18, 22, 28, 35,
              42, 38, 32, 25, 18, 14, 10,
            ],
            daily: [156, 189, 204, 178, 192, 210, 198],
            engagement: [25, 40, 20, 10, 5],
            sources: [65, 25, 10],
          },
          topArtworks:
            artworks.length > 0
              ? artworks.slice(0, 5).map((artwork, index) => ({
                  title: artwork.title,
                  artist: artwork.artist,
                  views: Math.floor(Math.random() * 200) + 50, // Random views for demo
                }))
              : [
                  {
                    title: "Starry Night",
                    artist: "Vincent van Gogh",
                    views: 245,
                  },
                  {
                    title: "The Persistence of Memory",
                    artist: "Salvador DalÃ­",
                    views: 189,
                  },
                  { title: "The Night Watch", artist: "Rembrandt", views: 167 },
                  {
                    title: "Girl with a Pearl Earring",
                    artist: "Johannes Vermeer",
                    views: 142,
                  },
                  {
                    title: "The Birth of Venus",
                    artist: "Sandro Botticelli",
                    views: 128,
                  },
                ],
        };
      }

      function updateStats(stats) {
        document.getElementById("totalScans").textContent =
          stats.totalScans.toLocaleString();
        document.getElementById("totalArtworks").textContent =
          stats.totalArtworks;
        document.getElementById("uniqueVisitors").textContent =
          stats.uniqueVisitors.toLocaleString();
        document.getElementById("avgEngagement").textContent =
          stats.avgEngagement;
      }

      function updateCharts(chartData) {
        // Destroy existing charts if they exist
        if (hourlyChart) hourlyChart.destroy();
        if (dailyChart) dailyChart.destroy();
        if (engagementChart) engagementChart.destroy();
        if (sourceChart) sourceChart.destroy();

        // Hourly Scans Chart
        const hourlyCtx = document
          .getElementById("hourlyChart")
          .getContext("2d");
        hourlyChart = new Chart(hourlyCtx, {
          type: "line",
          data: {
            labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
            datasets: [
              {
                label: "Scans per Hour",
                data: chartData.hourly,
                borderColor: "#2c5aa0",
                backgroundColor: "rgba(44, 90, 160, 0.1)",
                tension: 0.4,
                fill: true,
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                mode: "index",
                intersect: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Number of Scans",
                },
              },
              x: {
                title: {
                  display: true,
                  text: "Time of Day",
                },
              },
            },
          },
        });

        // Daily Scans Chart
        const dailyCtx = document.getElementById("dailyChart").getContext("2d");
        dailyChart = new Chart(dailyCtx, {
          type: "bar",
          data: {
            labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
            datasets: [
              {
                label: "Scans per Day",
                data: chartData.daily,
                backgroundColor: "#4CAF50",
                borderColor: "#45a049",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Number of Scans",
                },
              },
            },
          },
        });

        // Engagement Chart
        const engagementCtx = document
          .getElementById("engagementChart")
          .getContext("2d");
        engagementChart = new Chart(engagementCtx, {
          type: "doughnut",
          data: {
            labels: ["<1 min", "1-3 min", "3-5 min", "5-10 min", ">10 min"],
            datasets: [
              {
                data: chartData.engagement,
                backgroundColor: [
                  "#FF6384",
                  "#36A2EB",
                  "#FFCE56",
                  "#4BC0C0",
                  "#9966FF",
                ],
                borderWidth: 2,
                borderColor: "#fff",
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "bottom",
              },
            },
          },
        });

        // Source Chart
        const sourceCtx = document
          .getElementById("sourceChart")
          .getContext("2d");
        sourceChart = new Chart(sourceCtx, {
          type: "pie",
          data: {
            labels: ["QR Code Scan", "Manual Entry", "Image Upload"],
            datasets: [
              {
                data: chartData.sources,
                backgroundColor: ["#2c5aa0", "#4CAF50", "#FF9800"],
                borderWidth: 2,
                borderColor: "#fff",
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: "bottom",
              },
            },
          },
        });
      }

      function updateTopArtworks(artworks) {
        const container = document.getElementById("topArtworksList");

        if (artworks.length === 0) {
          container.innerHTML =
            '<div class="loading">No scan data available</div>';
          return;
        }

        container.innerHTML = artworks
          .map(
            (artwork, index) => `
                <div class="artwork-item">
                    <div class="artwork-rank">#${index + 1}</div>
                    <div class="artwork-info">
                        <strong>${artwork.title}</strong>
                        <div>by ${artwork.artist}</div>
                    </div>
                    <div class="artwork-views">
                        ${artwork.views} views
                    </div>
                </div>
            `
          )
          .join("");
      }

      function exportData() {
        if (!currentAnalyticsData) {
          alert(
            "No data available to export. Please refresh the analytics first."
          );
          return;
        }

        // Create a CSV string
        let csv = "ArtView Museum Analytics Export\n\n";
        csv += "Overview Statistics\n";
        csv += `Total Scans,${currentAnalyticsData.stats.totalScans}\n`;
        csv += `Total Artworks,${currentAnalyticsData.stats.totalArtworks}\n`;
        csv += `Unique Visitors,${currentAnalyticsData.stats.uniqueVisitors}\n`;
        csv += `Average Engagement,${currentAnalyticsData.stats.avgEngagement}\n\n`;

        csv += "Top Artworks\n";
        csv += "Rank,Title,Artist,Views\n";
        currentAnalyticsData.topArtworks.forEach((artwork, index) => {
          csv += `${index + 1},${artwork.title},${artwork.artist},${
            artwork.views
          }\n`;
        });

        // Create and download the file
        const blob = new Blob([csv], { type: "text/csv" });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `artview-analytics-${
          new Date().toISOString().split("T")[0]
        }.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      }

      // Auto-refresh every 5 minutes
      setInterval(loadAnalytics, 5 * 60 * 1000);
    </script>
  </body>
</html>
