<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scan Artwork - ArtView Museum</title>
    <link rel="stylesheet" href="css/style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Include QR Code scanning library -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
      .scanning-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        color: white;
      }

      .scanning-animation {
        width: 200px;
        height: 200px;
        border: 2px solid #fff;
        position: relative;
        margin-bottom: 2rem;
      }

      .scanning-line {
        position: absolute;
        width: 100%;
        height: 2px;
        background: #4caf50;
        animation: scan 2s linear infinite;
      }

      @keyframes scan {
        0% {
          top: 0;
        }
        100% {
          top: 100%;
        }
      }

      .upload-preview {
        max-width: 300px;
        max-height: 300px;
        margin: 1rem auto;
        display: none;
        border: 2px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        background: white;
      }

      .processing-message {
        text-align: center;
        padding: 1rem;
        display: none;
        background: #f8f9fa;
        border-radius: 8px;
        margin: 1rem 0;
      }

      .scanner-result {
        margin-top: 2rem;
        padding: 2rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #e0e0e0;
      }

      .artwork-result {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 2rem;
        align-items: start;
      }

      .artwork-image {
        text-align: center;
      }

      .artwork-image img {
        width: 100%;
        max-width: 300px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .artwork-info h2 {
        color: #2c5aa0;
        margin-bottom: 0.5rem;
        font-family: "Playfair Display", serif;
      }

      .artist {
        font-size: 1.2rem;
        color: #666;
        margin-bottom: 1.5rem;
        font-style: italic;
      }

      .artwork-meta {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .meta-item {
        padding: 0.5rem;
      }

      .meta-item strong {
        color: #333;
        display: block;
        margin-bottom: 0.25rem;
      }

      .artwork-description {
        line-height: 1.6;
        color: #444;
      }

      .artwork-description p {
        margin-bottom: 1rem;
      }

      .result-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e0e0e0;
      }

      .success-icon {
        color: #4caf50;
        font-size: 2rem;
      }

      .result-header h3 {
        color: #2c5aa0;
        margin: 0;
      }

      .result-actions {
        text-align: center;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid #e0e0e0;
      }

      .upload-section-content {
        text-align: center;
      }

      @media (max-width: 768px) {
        .artwork-result {
          grid-template-columns: 1fr;
          gap: 1rem;
        }

        .artwork-meta {
          grid-template-columns: 1fr;
        }

        .artwork-image img {
          max-width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <nav class="navbar">
          <div class="logo">
            <i class="fas fa-museum logo-icon"></i>
            <span>ArtView Scanner</span>
          </div>
          <div class="nav-links">
            <a href="index.html" class="nav-link">Home</a>
            <a href="scanner.html" class="nav-link active">Scan Art</a>
            <a href="login.html" class="nav-link">Staff</a>
          </div>
        </nav>
      </div>
    </header>

    <section class="scanner-hero">
      <div class="container">
        <h1>Discover Art Stories</h1>
        <p>
          Scan QR codes to unlock detailed information about each masterpiece
        </p>
      </div>
    </section>

    <main class="main-content">
      <div class="container">
        <div class="scanner-container">
          <div class="scanner-options">
            <div class="option-card active" id="optionManual">
              <div class="option-icon">
                <i class="fas fa-keyboard"></i>
              </div>
              <h3>Enter Code</h3>
              <p>Type the artwork ID manually</p>
            </div>

            <div class="option-card" id="optionUpload">
              <div class="option-icon">
                <i class="fas fa-upload"></i>
              </div>
              <h3>Upload Image</h3>
              <p>Upload a photo of the QR code</p>
            </div>
          </div>

          <div class="scanner-section active" id="manualSection">
            <div class="manual-input-area">
              <i class="fas fa-search"></i>
              <h3>Enter Artwork ID</h3>
              <p>Find the ID below the QR code on the display</p>
              <div class="input-group">
                <input
                  type="text"
                  id="manualCode"
                  placeholder="Enter artwork ID"
                />
                <button onclick="loadArtworkManually()" class="btn btn-primary">
                  <i class="fas fa-search"></i>
                  Find Artwork
                </button>
              </div>
            </div>
          </div>

          <div class="scanner-section" id="uploadSection" style="display: none">
            <div class="upload-section-content">
              <div class="upload-area" id="uploadArea">
                <i class="fas fa-cloud-upload-alt"></i>
                <h3>Click to upload or drag and drop</h3>
                <p>JPG, PNG, GIF (Max 10MB)</p>
                <input
                  type="file"
                  id="fileInput"
                  accept="image/jpeg,image/jpg,image/png,image/gif"
                  style="display: none"
                />
              </div>
              <img
                id="uploadPreview"
                class="upload-preview"
                alt="QR Code Preview"
              />
              <div class="processing-message" id="processingMessage">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Scanning QR code...</p>
              </div>
            </div>
          </div>

          <!-- Artwork Results will be displayed here separately -->
          <div
            id="scannerResult"
            class="scanner-result"
            style="display: none"
          ></div>

          <div id="errorMessage" class="error-message" style="display: none">
            <div class="error-icon">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3>Artwork Not Found</h3>
            <p>
              We couldn't find an artwork matching that code. Please check and
              try again.
            </p>
            <button onclick="hideError()" class="btn btn-primary">
              <i class="fas fa-redo"></i>
              Try Again
            </button>
          </div>

          <div class="help-section">
            <div class="help-card">
              <h3><i class="fas fa-question-circle"></i> Need Help?</h3>
              <p>
                QR codes are located next to each artwork. Look for the black
                and white square codes on wall labels or stands near the
                artwork.
              </p>
              <div class="help-tips">
                <div class="tip">
                  <i class="fas fa-lightbulb"></i>
                  <span>Ensure good lighting when scanning</span>
                </div>
                <div class="tip">
                  <i class="fas fa-hand-point-up"></i>
                  <span>Hold your phone steady for better recognition</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Scanning Overlay -->
    <div class="scanning-overlay" id="scanningOverlay">
      <div class="scanning-animation">
        <div class="scanning-line"></div>
      </div>
      <h3>Scanning QR Code...</h3>
      <p>Please wait while we process your image</p>
    </div>

    <footer>
      <div class="container">
        <div class="footer-content">
          <div class="footer-section">
            <h3>ArtView Museum</h3>
            <p>Enhancing your museum experience through technology.</p>
          </div>
        </div>
      </div>
    </footer>

    <script>
      // Initialize the scanner functionality
      document.addEventListener("DOMContentLoaded", function () {
        initializeScanner();
      });

      function initializeScanner() {
        // Tab switching
        document
          .getElementById("optionManual")
          .addEventListener("click", switchToManual);
        document
          .getElementById("optionUpload")
          .addEventListener("click", switchToUpload);

        // File upload functionality
        const uploadArea = document.getElementById("uploadArea");
        const fileInput = document.getElementById("fileInput");

        uploadArea.addEventListener("click", function () {
          fileInput.click();
        });

        uploadArea.addEventListener("dragover", function (e) {
          e.preventDefault();
          uploadArea.classList.add("dragover");
        });

        uploadArea.addEventListener("dragleave", function () {
          uploadArea.classList.remove("dragover");
        });

        uploadArea.addEventListener("drop", function (e) {
          e.preventDefault();
          uploadArea.classList.remove("dragover");
          if (e.dataTransfer.files.length) {
            handleFileUpload(e.dataTransfer.files[0]);
          }
        });

        fileInput.addEventListener("change", function (e) {
          if (e.target.files.length) {
            handleFileUpload(e.target.files[0]);
          }
        });
      }

      function switchToManual() {
        document.getElementById("manualSection").style.display = "block";
        document.getElementById("uploadSection").style.display = "none";
        document.getElementById("optionManual").classList.add("active");
        document.getElementById("optionUpload").classList.remove("active");
        // Hide results when switching tabs
        document.getElementById("scannerResult").style.display = "none";
      }

      function switchToUpload() {
        document.getElementById("manualSection").style.display = "none";
        document.getElementById("uploadSection").style.display = "block";
        document.getElementById("optionManual").classList.remove("active");
        document.getElementById("optionUpload").classList.add("active");
        // Hide results when switching tabs
        document.getElementById("scannerResult").style.display = "none";
      }

      function handleFileUpload(file) {
        // Hide any previous results
        document.getElementById("scannerResult").style.display = "none";

        // Validate file type
        const validTypes = [
          "image/jpeg",
          "image/jpg",
          "image/png",
          "image/gif",
        ];
        if (!validTypes.includes(file.type)) {
          showError("Please select a valid image file (JPG, PNG, or GIF)");
          return;
        }

        // Validate file size (10MB max)
        if (file.size > 10 * 1024 * 1024) {
          showError("File size must be less than 10MB");
          return;
        }

        // Show scanning overlay
        document.getElementById("scanningOverlay").style.display = "flex";
        document.getElementById("processingMessage").style.display = "block";

        // Create image for processing
        const img = new Image();
        const reader = new FileReader();

        reader.onload = function (e) {
          img.src = e.target.result;
          img.onload = function () {
            // Show preview of the uploaded QR code
            const preview = document.getElementById("uploadPreview");
            preview.src = e.target.result;
            preview.style.display = "block";

            // Process QR code
            processQRCode(img);
          };
        };

        reader.readAsDataURL(file);
      }

      function processQRCode(image) {
        try {
          // Create canvas for image processing
          const canvas = document.createElement("canvas");
          const context = canvas.getContext("2d");
          canvas.width = image.width;
          canvas.height = image.height;
          context.drawImage(image, 0, 0, canvas.width, canvas.height);

          // Get image data for QR code scanning
          const imageData = context.getImageData(
            0,
            0,
            canvas.width,
            canvas.height
          );

          // Scan for QR code using jsQR library
          const code = jsQR(imageData.data, imageData.width, imageData.height, {
            inversionAttempts: "dontInvert",
          });

          // Hide scanning overlay
          document.getElementById("scanningOverlay").style.display = "none";

          if (code) {
            // QR code found - automatically process it
            console.log("QR Code detected:", code.data);
            extractAndLoadArtwork(code.data);
          } else {
            // No QR code found
            document.getElementById("processingMessage").style.display = "none";
            showError(
              "No QR code found in the image. Please try again with a clearer image."
            );
          }
        } catch (error) {
          console.error("Error processing QR code:", error);
          document.getElementById("scanningOverlay").style.display = "none";
          document.getElementById("processingMessage").style.display = "none";
          showError("Error processing image. Please try again.");
        }
      }

      function extractAndLoadArtwork(qrData) {
        try {
          let artworkId;

          // Try to parse as JSON first (if it's from our admin system)
          try {
            const parsedData = JSON.parse(qrData);
            artworkId = parsedData.id;
          } catch (e) {
            // If not JSON, assume it's directly the artwork ID
            artworkId = qrData.trim();
          }

          if (artworkId) {
            // Load artwork directly without asking for ID
            loadArtwork(artworkId);
          } else {
            showError("Could not extract artwork ID from QR code.");
          }
        } catch (error) {
          console.error("Error extracting artwork ID:", error);
          showError("Error reading QR code data.");
        }
      }

      function loadArtwork(artworkId) {
        // Show loading state
        document.getElementById("processingMessage").innerHTML =
          '<i class="fas fa-spinner fa-spin"></i><p>Loading artwork details...</p>';
        document.getElementById("processingMessage").style.display = "block";

        // Get artworks from localStorage (from admin system)
        const artworks = JSON.parse(localStorage.getItem("artworks")) || [];
        const artwork = artworks.find(
          (a) => a.id == artworkId || a.id.toString() === artworkId
        );

        if (artwork) {
          // Display artwork details
          displayArtworkResult(artwork);
        } else {
          // Try demo artworks if not found in localStorage
          loadDemoArtwork(artworkId);
        }
      }

      function displayArtworkResult(artwork) {
        const resultDiv = document.getElementById("scannerResult");

        resultDiv.innerHTML = `
          <div class="artwork-result">
            <div class="artwork-image">
              <img src="${artwork.image}" alt="${artwork.title}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y0ZjRmNCIvPjx0ZXh0IHg9IjE1MCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjM1ZW0iPkFydHdvcmsgSW1hZ2U8L3RleHQ+PC9zdmc+'">
            </div>
            <div class="artwork-info">
              <div class="result-header">
                <i class="fas fa-check-circle success-icon"></i>
                <h3>Artwork Found!</h3>
              </div>
              <h2>${artwork.title}</h2>
              <p class="artist">By ${artwork.artist}</p>
              <div class="artwork-meta">
                <div class="meta-item">
                  <strong>Year:</strong> ${artwork.year}
                </div>
                <div class="meta-item">
                  <strong>Medium:</strong> ${artwork.medium}
                </div>
                <div class="meta-item">
                  <strong>Dimensions:</strong> ${artwork.dimensions}
                </div>
                <div class="meta-item">
                  <strong>Artwork ID:</strong> ${artwork.id}
                </div>
              </div>
              <div class="artwork-description">
                <p>${artwork.description}</p>
              </div>
              <div class="result-actions">
                <button onclick="resetScanner()" class="btn btn-primary">
                  <i class="fas fa-qrcode"></i>
                  Scan Another QR Code
                </button>
              </div>
            </div>
          </div>
        `;

        resultDiv.style.display = "block";
        document.getElementById("processingMessage").style.display = "none";

        // Scroll to result
        resultDiv.scrollIntoView({ behavior: "smooth" });
      }

      function loadDemoArtwork(artworkId) {
        // Demo artworks for testing
        const demoArtworks = {
          1762230159416: {
            id: 1762230159416,
            title: "Starry Night",
            artist: "Vincent van Gogh",
            year: "1889",
            medium: "Oil on canvas",
            dimensions: "73.7 × 92.1 cm",
            description:
              "One of the most recognized paintings in Western art, Starry Night depicts the view from the east-facing window of van Gogh's asylum room at Saint-Rémy-de-Provence, just before sunrise, with the addition of an imaginary village. The painting features swirling clouds, a bright crescent moon, and a sleeping village, all dominated by the night sky. Van Gogh wrote about this painting to his brother Theo, describing the 'enormous need for religion' that prompted him to paint this night sky.",
            image:
              "https://upload.wikimedia.org/wikipedia/commons/thumb/e/ea/Van_Gogh_-_Starry_Night_-_Google_Art_Project.jpg/300px-Van_Gogh_-_Starry_Night_-_Google_Art_Project.jpg",
          },
          "ART-2024-001": {
            id: "ART-2024-001",
            title: "The Persistence of Memory",
            artist: "Salvador Dalí",
            year: "1931",
            medium: "Oil on canvas",
            dimensions: "24 × 33 cm",
            description:
              "This iconic Surrealist work is known for its melting clocks, which symbolize the relativity of space and time. The painting explores dreams, subconscious thoughts, and the nature of reality. Set against a landscape background of Port Lligat, Dalí's home, the painting features bizarre, dream-like images including the famous soft watches, a strange fleshy creature, and ants crawling on a pocket watch. The work has become a symbol of Surrealism and continues to fascinate viewers with its mysterious symbolism.",
            image:
              "https://upload.wikimedia.org/wikipedia/en/d/dd/The_Persistence_of_Memory.jpg",
          },
        };

        const artwork = demoArtworks[artworkId];
        if (artwork) {
          displayArtworkResult(artwork);
        } else {
          document.getElementById("processingMessage").style.display = "none";
          showError(
            `Artwork with ID "${artworkId}" not found in our database.`
          );
        }
      }

      function loadArtworkManually() {
        const manualCode = document.getElementById("manualCode").value.trim();
        if (manualCode) {
          loadArtwork(manualCode);
        } else {
          showError("Please enter an artwork ID");
        }
      }

      function showError(message) {
        const errorDiv = document.getElementById("errorMessage");
        errorDiv.querySelector("p").textContent = message;
        errorDiv.style.display = "block";

        // Scroll to error
        errorDiv.scrollIntoView({ behavior: "smooth" });
      }

      function hideError() {
        document.getElementById("errorMessage").style.display = "none";
      }

      function resetScanner() {
        // Reset everything to initial state
        document.getElementById("scannerResult").style.display = "none";
        document.getElementById("uploadPreview").style.display = "none";
        document.getElementById("processingMessage").style.display = "none";
        document.getElementById("fileInput").value = "";
        document.getElementById("manualCode").value = "";
        hideError();

        // Switch to upload tab
        switchToUpload();
      }
    </script>
    <script src="js/engagement.js"></script>
  </body>
</html>
